package fr.xmalware.bukkit.badybots;

import java.net.InetAddress;

import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerLoginEvent.Result;
import org.bukkit.plugin.java.JavaPlugin;

import fr.xmalware.bukkit.badybots.checks.abstracts.CheckResponse;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckType;
import fr.xmalware.bukkit.badybots.database.BadblockDatabase;
import fr.xmalware.bukkit.badybots.database.DatabaseManager;
import fr.xmalware.bukkit.badybots.listeners.PlayerLoginsListeners;

public class BadyBots extends JavaPlugin {

	public static BadyBots instance;

	@Override
	public void onEnable() {
		instance = this;
		// Load config
		this.reloadConfig();
		// Load checks
		CheckType.load();
		// Register listeners
		this.getServer().getPluginManager().registerEvents(new PlayerLoginsListeners(), this);
		// Load database
		BadblockDatabase.getInstance().connect(this.getConfig().getString("database.hostname"),
				this.getConfig().getInt("database.port"),
				this.getConfig().getString("database.username"),
				this.getConfig().getString("database.password"),
				this.getConfig().getString("database.database"));
		new DatabaseManager();
	}

	@Override
	public void onDisable() {

	}

	public static void work(Player player, CheckType checkType, CheckResponse checkResponse) {
		work(player.getName(), player.getAddress().getAddress(), checkType, checkResponse);
		player.kickPlayer(giveError(checkType));
	}

	public static void work(PlayerLoginEvent event, CheckType checkType, CheckResponse checkResponse) {
		work(event.getPlayer().getName(), event.getAddress(), checkType, checkResponse);
		event.disallow(Result.KICK_BANNED, giveError(checkType));
	}
	
	private static void work(String playerName, InetAddress address, CheckType checkType, CheckResponse checkResponse) {
		String ip = address.getHostAddress();
		if (checkResponse.equals(CheckResponse.BAN)) {
			long expire = System.currentTimeMillis() + (3600 * 1000);
			System.out.println("INSERT INTO badybots(playerName, ip, type, expire) VALUES('" + playerName + "', '" + ip + "', '" + checkType.name() + "', '" + expire + "')");
			DatabaseManager.sendQuery("INSERT INTO badybots(playerName, ip, type, expire) VALUES('" + playerName + "', '" + ip + "', '" + checkType.name() + "', '" + expire + "')"); 
		}
        Bukkit.getConsoleSender().sendMessage("§a[BadyBots] §c" + playerName + " disallowed! (" + (checkResponse.equals(CheckResponse.BAN) ? "Banned" : "Kicked") + ")");
	}

	public static String giveError(CheckType checkType) {
		return "§c(BadyBots) Votre requête a été rejetée par notre AntiBot. Code d'erreur: #ERR-" + (checkType != null ? checkType.id : "0");
	}

}
