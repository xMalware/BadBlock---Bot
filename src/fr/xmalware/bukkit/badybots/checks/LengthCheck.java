package fr.xmalware.bukkit.badybots.checks;

import java.util.HashMap;
import java.util.Map;
import java.util.Queue;

import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerQuitEvent;

import com.google.common.collect.Queues;

import fr.xmalware.bukkit.badybots.checks.abstracts.Check;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckResponse;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckType;

public class LengthCheck extends Check {

	private Map<Integer, Queue<Long>> data = new HashMap<>();
	
	public LengthCheck() {
		super(CheckType.LENGTH_CHECK);
	}

	@Override
	public CheckResponse onLogin(PlayerLoginEvent event) {
		CheckResponse checkResponse = CheckResponse.ALLOW;
		String playerName = event.getPlayer().getName().toLowerCase();
		int length = playerName.length();
		Queue<Long> queue = data.get(length);
		long time = System.currentTimeMillis();
		if (queue == null) {
			queue = Queues.newLinkedBlockingQueue();
			data.put(length, queue);
		}
		if (queue.size() >= 5) {
			long last = queue.poll();
			long difference = time - last;
			if (difference <= 30_000L) {
				checkResponse = CheckResponse.KICK;
			}
		}
		queue.add(time);
		return checkResponse;
	}

	@Override
	public CheckResponse onJoin(PlayerJoinEvent event) {
		return CheckResponse.ALLOW;
	}

	@Override
	public CheckResponse onCommandPreprocess(PlayerCommandPreprocessEvent event) {
		return CheckResponse.ALLOW;
	}
	
	@Override
	public void onPlayerQuit(PlayerQuitEvent event) {
	}

}
