package fr.xmalware.bukkit.badybots.checks;

import java.util.HashMap;
import java.util.Queue;

import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerQuitEvent;

import com.google.common.collect.Queues;

import fr.xmalware.bukkit.badybots.checks.abstracts.Check;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckResponse;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckType;

public class LoginIPFast extends Check {

	private static HashMap<String, Queue<Long>> logins = new HashMap<>();
	
	public LoginIPFast() {
		super(CheckType.LOGIN_IP_FAST);
	}

	@Override
	public CheckResponse onLogin(PlayerLoginEvent event) {
		CheckResponse checkResponse = CheckResponse.ALLOW;
		String ip = event.getAddress().getHostAddress();
		ip = ip.substring(0, 4);
		Queue<Long> queue = logins.get(ip);
		if (queue == null) {
			queue = Queues.newLinkedBlockingQueue();
			logins.put(ip, queue);
		}
		long time = System.currentTimeMillis();
		if (queue.size() >= 2) {
			long last = queue.poll();
			long difference = time - last;
			if (difference <= 5_000L) {
				checkResponse = CheckResponse.BAN;
			}
		}
		queue.add(time);
		return checkResponse;
	}

	@Override
	public CheckResponse onJoin(PlayerJoinEvent event) {
		return CheckResponse.ALLOW;
	}

	@Override
	public CheckResponse onCommandPreprocess(PlayerCommandPreprocessEvent event) {
		return CheckResponse.ALLOW;
	}
	
	@Override
	public void onPlayerQuit(PlayerQuitEvent event) {
	}
	
}
