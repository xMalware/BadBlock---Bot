package fr.xmalware.bukkit.badybots.checks;

import java.io.InputStream;
import java.net.URL;
import java.net.URLConnection;

import org.apache.commons.io.IOUtils;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerQuitEvent;

import fr.xmalware.bukkit.badybots.checks.abstracts.Check;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckResponse;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckType;

public class CheckIP extends Check {

	public CheckIP() {
		super(CheckType.CHECK_IP);
	}

	@Override
	public CheckResponse onLogin(PlayerLoginEvent event) {
		CheckResponse checkResponse = CheckResponse.ALLOW;
		String ip = event.getAddress().getHostAddress();
		String sourceCode = sourceCode("http://check.getipintel.net/check.php?ip=" + ip + "&contact=xmalware2@gmail.com");
		double code = 0;
		try {
			code = Double.parseDouble(sourceCode);
		}catch(Exception error) {
			error.printStackTrace();
		}
		if (code > 0.5) {
			checkResponse = CheckResponse.BAN;
		}
		return checkResponse;
	}

	@Override
	public CheckResponse onJoin(PlayerJoinEvent event) {
		return CheckResponse.ALLOW;
	}

	@Override
	public CheckResponse onCommandPreprocess(PlayerCommandPreprocessEvent event) {
		return CheckResponse.ALLOW;
	}
	
	@Override
	public void onPlayerQuit(PlayerQuitEvent event) {
	}

	public static String sourceCode(String link) {
		try {
			URL url = new URL(link);
			URLConnection con = url.openConnection();
			InputStream in = con.getInputStream();
			String encoding = con.getContentEncoding();
			encoding = encoding == null ? "UTF-8" : encoding;
			String body = IOUtils.toString(in, encoding);
			return body;
		}catch(Exception error) {
			return "0";
		}
	}

}
