package fr.xmalware.bukkit.badybots.listeners;

import java.sql.ResultSet;

import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerLoginEvent.Result;
import org.bukkit.event.player.PlayerQuitEvent;

import fr.xmalware.bukkit.badybots.BadyBots;
import fr.xmalware.bukkit.badybots.checks.abstracts.Check;
import fr.xmalware.bukkit.badybots.checks.abstracts.CheckResponse;
import fr.xmalware.bukkit.badybots.database.DatabaseManager;

public class PlayerLoginsListeners implements Listener {

	@EventHandler
	public void onPlayerJoin(PlayerJoinEvent event) {
		for (Check check : Check.checks) {
			CheckResponse response = check.onJoin(event);
			if (!(response.equals(CheckResponse.ALLOW))) {
				BadyBots.work(event.getPlayer(), check.getCheckType(), response);
				break;
			}
		}
	}
	
	@EventHandler
	public void onPlayerCommandPreprocess(PlayerCommandPreprocessEvent event) {
		for (Check check : Check.checks) {
			CheckResponse response = check.onCommandPreprocess(event);
			if (!(response.equals(CheckResponse.ALLOW))) {
				event.setCancelled(true);
				BadyBots.work(event.getPlayer(), check.getCheckType(), response);
				break;
			}
		}
	}
	
	@EventHandler
	public void onPlayerLogin(PlayerLoginEvent event) {
		// Check IP ban
		String ip = event.getAddress().getHostAddress();
		long time = System.currentTimeMillis();
		try {
			ResultSet resultSet = DatabaseManager.syncQuery("SELECT COUNT(*) AS count FROM badybots WHERE ip = '" + ip + "' AND expire > '" + time + "'");
			if (resultSet.next()) {
				int count = resultSet.getInt("count");
				if (count > 0) {
					event.disallow(Result.KICK_BANNED, BadyBots.giveError(null));
			        Bukkit.getConsoleSender().sendMessage("§a[BadyBots] " + event.getPlayer().getName() + " is trying to connect: IP is already banned.");
					resultSet.close();
					return;
				}
			}
			resultSet.close();
		} catch (Exception e) {
			e.printStackTrace();
		}
        Bukkit.getConsoleSender().sendMessage("§a[BadyBots] §bLooking for " + event.getPlayer().getName() + "...");
		for (Check check : Check.checks) {
			CheckResponse response = check.onLogin(event);
			if (!(response.equals(CheckResponse.ALLOW))) {
				BadyBots.work(event, check.getCheckType(), response);
				break;
			}
		}
        Bukkit.getConsoleSender().sendMessage("§a[BadyBots] " + event.getPlayer().getName() + " allowed.");
	}
	
	@EventHandler
	public void onPlayerQuit(PlayerQuitEvent event) {
		for (Check check : Check.checks) {
			check.onPlayerQuit(event);
		}
	}
	
}
